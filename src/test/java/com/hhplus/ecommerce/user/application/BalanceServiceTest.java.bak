package com.hhplus.ecommerce.application.user;

import com.hhplus.ecommerce.config.TestContainersConfig;
import com.hhplus.ecommerce.domain.user.BalanceHistory;
import com.hhplus.ecommerce.domain.user.BalanceTransactionType;
import com.hhplus.ecommerce.domain.user.User;
import com.hhplus.ecommerce.domain.user.UserRole;
import com.hhplus.ecommerce.domain.user.UserStatus;
import com.hhplus.ecommerce.infrastructure.persistence.cart.CartItemRepository;
import com.hhplus.ecommerce.infrastructure.persistence.cart.CartRepository;
import com.hhplus.ecommerce.infrastructure.persistence.user.BalanceHistoryRepository;
import com.hhplus.ecommerce.infrastructure.persistence.user.UserRepository;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Nested;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.context.annotation.Import;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.test.context.ActiveProfiles;
import org.springframework.transaction.annotation.Transactional;
import org.testcontainers.junit.jupiter.Testcontainers;

import java.math.BigDecimal;
import java.time.LocalDateTime;

import static org.assertj.core.api.Assertions.*;

/**
 * BalanceService 통합 테스트 (TestContainers 사용)
 *
 * 테스트 전략:
 * - 실제 MySQL 컨테이너를 사용한 통합 테스트
 * - JPA, 트랜잭션, DB 제약조건 등 실제 동작 검증
 * - 비관적 락을 통한 동시성 제어 검증
 */
@SpringBootTest
@Testcontainers
@Import(TestContainersConfig.class)
@ActiveProfiles("test")
@DisplayName("BalanceService 통합 테스트 (TestContainers)")
class BalanceServiceTest {

    @Autowired
    private BalanceService balanceService;

    @Autowired
    private UserRepository userRepository;

    @Autowired
    private BalanceHistoryRepository balanceHistoryRepository;

    @Autowired
    private CartRepository cartRepository;

    @Autowired
    private CartItemRepository cartItemRepository;

    @Autowired
    private org.springframework.jdbc.core.JdbcTemplate jdbcTemplate;

    private User testUser;

    @BeforeEach
    void setUp() {
        // 각 테스트 전에 DB 초기화 (외래키 제약조건 순서 고려)
        // Native query로 외래 키 제약 조건을 우회하여 삭제
        jdbcTemplate.execute("SET FOREIGN_KEY_CHECKS = 0");

        cartItemRepository.deleteAll();
        cartRepository.deleteAll();
        balanceHistoryRepository.deleteAll();
        userRepository.deleteAll();

        jdbcTemplate.execute("SET FOREIGN_KEY_CHECKS = 1");

        // 테스트용 사용자 생성
        testUser = createAndSaveUser("test@test.com", BigDecimal.valueOf(10000));
    }

    @Nested
    @DisplayName("잔액 충전 테스트")
    class ChargeBalanceTest {

        @Test
        @DisplayName("성공: 잔액 충전 및 이력 저장")
        void chargeBalance_Success() {
            // Given
            Long userId = testUser.getId();
            BigDecimal chargeAmount = BigDecimal.valueOf(5000);
            BigDecimal expectedBalance = BigDecimal.valueOf(15000); // 10000 + 5000

            // When
            BigDecimal result = balanceService.chargeBalance(userId, chargeAmount);

            // Then
            assertThat(result).isEqualByComparingTo(expectedBalance);

            // 실제 DB에서 사용자 잔액 확인
            User updatedUser = userRepository.findById(userId).orElseThrow();
            assertThat(updatedUser.getBalance()).isEqualByComparingTo(expectedBalance);

            // 잔액 이력이 저장되었는지 확인
            Pageable pageable = PageRequest.of(0, 10);
            Page<BalanceHistory> histories = balanceHistoryRepository.findByUserOrderByCreatedAtDesc(testUser, pageable);
            assertThat(histories.getContent()).hasSize(1);

            BalanceHistory savedHistory = histories.getContent().get(0);
            assertThat(savedHistory.getUser().getId()).isEqualTo(userId);
            assertThat(savedHistory.getType()).isEqualTo(BalanceTransactionType.CHARGE);
            assertThat(savedHistory.getAmount()).isEqualByComparingTo(chargeAmount);
            assertThat(savedHistory.getBalanceBefore()).isEqualByComparingTo(BigDecimal.valueOf(10000));
            assertThat(savedHistory.getBalanceAfter()).isEqualByComparingTo(expectedBalance);
        }

        @Test
        @DisplayName("성공: 여러 번 충전 시 잔액 누적")
        void chargeBalance_Multiple() {
            // Given
            Long userId = testUser.getId();
            BigDecimal charge1 = BigDecimal.valueOf(1000);
            BigDecimal charge2 = BigDecimal.valueOf(2000);
            BigDecimal charge3 = BigDecimal.valueOf(3000);

            // When
            balanceService.chargeBalance(userId, charge1);
            balanceService.chargeBalance(userId, charge2);
            BigDecimal finalBalance = balanceService.chargeBalance(userId, charge3);

            // Then
            assertThat(finalBalance).isEqualByComparingTo(BigDecimal.valueOf(16000)); // 10000 + 1000 + 2000 + 3000

            // 이력이 3개 저장되었는지 확인
            Pageable pageable = PageRequest.of(0, 10);
            Page<BalanceHistory> histories = balanceHistoryRepository.findByUserOrderByCreatedAtDesc(testUser, pageable);
            assertThat(histories.getContent()).hasSize(3);
        }

        @Test
        @DisplayName("성공: 큰 금액 충전 (오버플로우 없음)")
        void chargeBalance_LargeAmount() {
            // Given
            Long userId = testUser.getId();
            BigDecimal largeAmount = BigDecimal.valueOf(1000000);

            // When
            BigDecimal result = balanceService.chargeBalance(userId, largeAmount);

            // Then
            assertThat(result).isEqualByComparingTo(BigDecimal.valueOf(1010000)); // 10000 + 1000000
        }

        @Test
        @DisplayName("성공: 비관적 락으로 사용자 조회 (동시성 제어)")
        void chargeBalance_UsePessimisticLock() {
            // Given
            Long userId = testUser.getId();
            BigDecimal chargeAmount = BigDecimal.valueOf(1000);

            // When
            BigDecimal result = balanceService.chargeBalance(userId, chargeAmount);

            // Then
            assertThat(result).isEqualByComparingTo(BigDecimal.valueOf(11000));

            // 실제 DB에서 조회하여 확인
            User user = userRepository.findById(userId).orElseThrow();
            assertThat(user.getBalance()).isEqualByComparingTo(BigDecimal.valueOf(11000));
        }

        @Test
        @DisplayName("실패: 사용자를 찾을 수 없음")
        void chargeBalance_UserNotFound() {
            // Given
            Long nonExistentId = 999L;
            BigDecimal chargeAmount = BigDecimal.valueOf(5000);

            // When & Then
            assertThatThrownBy(() -> balanceService.chargeBalance(nonExistentId, chargeAmount))
                    .isInstanceOf(IllegalArgumentException.class)
                    .hasMessageContaining("사용자를 찾을 수 없습니다");

            // 이력은 저장되지 않아야 함
            Pageable pageable = PageRequest.of(0, 10);
            Page<BalanceHistory> histories = balanceHistoryRepository.findByUserOrderByCreatedAtDesc(testUser, pageable);
            assertThat(histories.getContent()).isEmpty();
        }

        @Test
        @DisplayName("실패: 충전 금액이 null")
        void chargeBalance_NullAmount() {
            // Given
            Long userId = testUser.getId();
            BigDecimal chargeAmount = null;

            // When & Then
            assertThatThrownBy(() -> balanceService.chargeBalance(userId, chargeAmount))
                    .isInstanceOf(IllegalArgumentException.class)
                    .hasMessageContaining("충전 금액은 필수입니다");
        }

        @Test
        @DisplayName("실패: 충전 금액이 0 이하")
        void chargeBalance_InvalidAmount() {
            // Given
            Long userId = testUser.getId();
            BigDecimal chargeAmount = BigDecimal.ZERO;

            // When & Then
            assertThatThrownBy(() -> balanceService.chargeBalance(userId, chargeAmount))
                    .isInstanceOf(IllegalArgumentException.class)
                    .hasMessageContaining("0보다 커야 합니다");
        }

        @Test
        @DisplayName("실패: 충전 금액이 1원 미만")
        void chargeBalance_LessThanOne() {
            // Given
            Long userId = testUser.getId();
            BigDecimal chargeAmount = BigDecimal.valueOf(0.5);

            // When & Then
            assertThatThrownBy(() -> balanceService.chargeBalance(userId, chargeAmount))
                    .isInstanceOf(IllegalArgumentException.class)
                    .hasMessageContaining("최소 1원 이상이어야 합니다");
        }

        @Test
        @DisplayName("실패: 음수 금액 충전 불가")
        void chargeBalance_NegativeAmount() {
            // Given
            Long userId = testUser.getId();
            BigDecimal chargeAmount = BigDecimal.valueOf(-1000);

            // When & Then
            assertThatThrownBy(() -> balanceService.chargeBalance(userId, chargeAmount))
                    .isInstanceOf(IllegalArgumentException.class)
                    .hasMessageContaining("0보다 커야 합니다");
        }
    }

    @Nested
    @DisplayName("잔액 조회 테스트")
    class GetBalanceTest {

        @Test
        @DisplayName("성공: 현재 잔액 조회")
        void getBalance_Success() {
            // Given
            Long userId = testUser.getId();

            // When
            BigDecimal result = balanceService.getBalance(userId);

            // Then
            assertThat(result).isEqualByComparingTo(BigDecimal.valueOf(10000));
        }

        @Test
        @DisplayName("성공: 충전 후 잔액 조회")
        void getBalance_AfterCharge() {
            // Given
            Long userId = testUser.getId();
            balanceService.chargeBalance(userId, BigDecimal.valueOf(5000));

            // When
            BigDecimal result = balanceService.getBalance(userId);

            // Then
            assertThat(result).isEqualByComparingTo(BigDecimal.valueOf(15000));
        }

        @Test
        @DisplayName("성공: 잔액이 0인 사용자")
        void getBalance_ZeroBalance() {
            // Given
            User userWithZeroBalance = createAndSaveUser("zero@test.com", BigDecimal.ZERO);

            // When
            BigDecimal result = balanceService.getBalance(userWithZeroBalance.getId());

            // Then
            assertThat(result).isEqualByComparingTo(BigDecimal.ZERO);
        }

        @Test
        @DisplayName("실패: 사용자를 찾을 수 없음")
        void getBalance_UserNotFound() {
            // Given
            Long nonExistentId = 999L;

            // When & Then
            assertThatThrownBy(() -> balanceService.getBalance(nonExistentId))
                    .isInstanceOf(IllegalArgumentException.class)
                    .hasMessageContaining("사용자를 찾을 수 없습니다");
        }
    }

    @Nested
    @DisplayName("잔액 이력 조회 테스트")
    class GetBalanceHistoryTest {

        @Test
        @DisplayName("성공: 잔액 변동 이력 조회")
        void getBalanceHistory_Success() {
            // Given
            Long userId = testUser.getId();
            Pageable pageable = PageRequest.of(0, 10);

            // 잔액 충전
            balanceService.chargeBalance(userId, BigDecimal.valueOf(5000));
            balanceService.chargeBalance(userId, BigDecimal.valueOf(3000));

            // When
            Page<BalanceHistory> result = balanceService.getBalanceHistory(userId, pageable);

            // Then
            assertThat(result.getContent()).hasSize(2);
            assertThat(result.getTotalElements()).isEqualTo(2);

            // 최신순으로 정렬되어야 함
            assertThat(result.getContent().get(0).getAmount()).isEqualByComparingTo(BigDecimal.valueOf(3000));
            assertThat(result.getContent().get(1).getAmount()).isEqualByComparingTo(BigDecimal.valueOf(5000));
        }

        @Test
        @DisplayName("성공: 이력이 없는 경우 빈 페이지 반환")
        void getBalanceHistory_Empty() {
            // Given
            Long userId = testUser.getId();
            Pageable pageable = PageRequest.of(0, 10);

            // When
            Page<BalanceHistory> result = balanceService.getBalanceHistory(userId, pageable);

            // Then
            assertThat(result.getContent()).isEmpty();
            assertThat(result.getTotalElements()).isEqualTo(0);
        }

        @Test
        @DisplayName("성공: 페이징 처리")
        void getBalanceHistory_Pagination() {
            // Given
            Long userId = testUser.getId();

            // 10번 충전
            for (int i = 1; i <= 10; i++) {
                balanceService.chargeBalance(userId, BigDecimal.valueOf(1000 * i));
            }

            Pageable firstPage = PageRequest.of(0, 3);
            Pageable secondPage = PageRequest.of(1, 3);

            // When
            Page<BalanceHistory> firstResult = balanceService.getBalanceHistory(userId, firstPage);
            Page<BalanceHistory> secondResult = balanceService.getBalanceHistory(userId, secondPage);

            // Then
            assertThat(firstResult.getContent()).hasSize(3);
            assertThat(secondResult.getContent()).hasSize(3);
            assertThat(firstResult.getTotalElements()).isEqualTo(10);
            assertThat(secondResult.getTotalElements()).isEqualTo(10);
        }

        @Test
        @DisplayName("성공: 다른 사용자의 이력은 조회되지 않음")
        void getBalanceHistory_OnlyOwnHistory() {
            // Given
            User anotherUser = createAndSaveUser("another@test.com", BigDecimal.valueOf(5000));

            balanceService.chargeBalance(testUser.getId(), BigDecimal.valueOf(1000));
            balanceService.chargeBalance(anotherUser.getId(), BigDecimal.valueOf(2000));

            Pageable pageable = PageRequest.of(0, 10);

            // When
            Page<BalanceHistory> result = balanceService.getBalanceHistory(testUser.getId(), pageable);

            // Then
            assertThat(result.getContent()).hasSize(1);
            assertThat(result.getContent().get(0).getUser().getId()).isEqualTo(testUser.getId());
        }

        @Test
        @DisplayName("실패: 사용자를 찾을 수 없음")
        void getBalanceHistory_UserNotFound() {
            // Given
            Long nonExistentId = 999L;
            Pageable pageable = PageRequest.of(0, 10);

            // When & Then
            assertThatThrownBy(() -> balanceService.getBalanceHistory(nonExistentId, pageable))
                    .isInstanceOf(IllegalArgumentException.class)
                    .hasMessageContaining("사용자를 찾을 수 없습니다");
        }
    }

    @Nested
    @DisplayName("잔액 이력 상세 검증 테스트")
    class BalanceHistoryDetailTest {

        @Test
        @DisplayName("성공: 이력의 balanceBefore와 balanceAfter 검증")
        void balanceHistory_BeforeAfterCheck() {
            // Given
            Long userId = testUser.getId();
            BigDecimal initialBalance = BigDecimal.valueOf(10000);
            BigDecimal chargeAmount = BigDecimal.valueOf(5000);

            // When
            balanceService.chargeBalance(userId, chargeAmount);

            // Then
            Pageable pageable = PageRequest.of(0, 10);
            Page<BalanceHistory> histories = balanceHistoryRepository.findByUserOrderByCreatedAtDesc(testUser, pageable);

            BalanceHistory history = histories.getContent().get(0);
            assertThat(history.getBalanceBefore()).isEqualByComparingTo(initialBalance);
            assertThat(history.getBalanceAfter()).isEqualByComparingTo(initialBalance.add(chargeAmount));
        }

        @Test
        @DisplayName("성공: 연속 충전 시 이력의 순서 검증")
        void balanceHistory_ChronologicalOrder() {
            // Given
            Long userId = testUser.getId();
            BigDecimal charge1 = BigDecimal.valueOf(1000);
            BigDecimal charge2 = BigDecimal.valueOf(2000);
            BigDecimal charge3 = BigDecimal.valueOf(3000);

            // When
            balanceService.chargeBalance(userId, charge1);
            balanceService.chargeBalance(userId, charge2);
            balanceService.chargeBalance(userId, charge3);

            // Then
            Pageable pageable = PageRequest.of(0, 10);
            Page<BalanceHistory> histories = balanceHistoryRepository.findByUserOrderByCreatedAtDesc(testUser, pageable);

            // 최신순 정렬 확인
            assertThat(histories.getContent().get(0).getAmount()).isEqualByComparingTo(charge3);
            assertThat(histories.getContent().get(1).getAmount()).isEqualByComparingTo(charge2);
            assertThat(histories.getContent().get(2).getAmount()).isEqualByComparingTo(charge1);
        }

        @Test
        @DisplayName("성공: 이력에 타임스탬프 저장 확인")
        void balanceHistory_TimestampCheck() {
            // Given
            Long userId = testUser.getId();
            LocalDateTime before = LocalDateTime.now();

            // When
            balanceService.chargeBalance(userId, BigDecimal.valueOf(1000));

            // Then
            LocalDateTime after = LocalDateTime.now();
            Pageable pageable = PageRequest.of(0, 10);
            Page<BalanceHistory> histories = balanceHistoryRepository.findByUserOrderByCreatedAtDesc(testUser, pageable);

            BalanceHistory history = histories.getContent().get(0);
            assertThat(history.getCreatedAt()).isNotNull();
            assertThat(history.getCreatedAt()).isBetween(before, after);
        }
    }

    // ========================================
    // 테스트 데이터 생성 헬퍼 메서드
    // ========================================

    private User createAndSaveUser(String email, BigDecimal balance) {
        User user = User.builder()
                .email(email)
                .password("password123")
                .name("테스트사용자")
                .balance(balance)
                .role(UserRole.USER)
                .status(UserStatus.ACTIVE)
                .build();
        return userRepository.save(user);
    }
}
